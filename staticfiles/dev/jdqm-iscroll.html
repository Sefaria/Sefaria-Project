<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>

	<title>Sefaria</title>

	<link rel="stylesheet" href="/js/lib/jquery-ui/css/black-tie/jquery-ui-1.8.7.custom.css">

	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a2/jquery.mobile-1.0a2.min.css" />

	<style>
		body {
			height: 100%;
			overflow-x: hidden;
		}

		#top {
			position: fixed;
			top: 0px;
			width: 100%;
			background: white;
			z-index: 5;
		}

		#header {
			font-size: 27px;
			font-weight: bold;
			margin: 7px 15px;
		}

		#gotoBox {
			position: absolute;
			background: white;
			z-index: 10;
			padding: 5px 25px;
			right: 3%;
			top: 50px;
			display: none;
			font-size: 17px;
			-webkit-box-shadow: 2px 2px 12px #333333;
			-moz-box-shadow: 2px 2px 12px #333333;
			border-radius: 5px;
			vertical-align: middle;

		}

		#openEg {
			font-style: italic;
			font-size: 14px;
			margin: 7px 5px 0px 5px;
		}

		#goto {
			font-size: 17px;
			width: 265px;

		}

		#closeGoto {
			float: right;
			font-size: 20px;
			position: relative;
			left: 18px;
			font-family: sans-serif;
			cursor: pointer;
		}

		#topLine {
			height: 1px;
			background: black;
		}

		#topButtons {
			float: right;
			margin: 15px;
		}

		.button {
			font-weight: bold;
			border: 1px solid #aaa;
			font-size: 16px;
			height: 20px;
			min-width: 60px;
			padding: 0px 4px;
			margin: 0px 2px;
			display: block;
			float: right;
			text-align: center;
			vertical-align: center;
			border-radius: 3px;
			-webkit-box-shadow: 2px 2px 4px #333333;
			-moz-box-shadow: 2px 2px 4px #333333;
		}


		.button:hover {
			background: black;
			color: white;
			cursor: pointer;
		}

		#loading {
			margin: 200px 75%;
			height: 25px;
		}

		#basetextWrpr {
			position:relative;
		    z-index:1;
			top: 74px;
		    width: 57%;
		    height: 90%;
		    overflow: hidden;
		}

		#basetext {
			width: 57%;
			padding-left: 40px;
			overflow: hidden;
			font-size: 24px;
			text-align: justify;
			line-height: 1.3;
			z-index: 2;
			background: white;
		}

		.verse {
			margin-right: 7px;
		}

		.verse .lfc {
			font-size: 32px;
			font-variant: small-caps;
			margin: 0px 5px 0px 50px;
		}

		.verse.block {
			display: block;
			margin-bottom: 24px;
			line-height: 1.2;
		}
		.verseNum {
			font-size: 16px;
			width: 20px;
			text-align: center;
			margin-right: 4px;
			padding-top: 7px;
			position: absolute;
			left: 0px;
		}

		#next {
			text-align: center;
			font-size: 20px;
			cursor: pointer;
			margin: 30px 0px;
			font-weight: bold;
		}

		#next:hover {
			text-decoration: underline;
		}

		#commentaryBox {
			position: fixed;
			width: 30%;
			height: 91%;
			right: 2%;
			top: 74px;
			overflow: hidden;
			text-overflow: ellipsis;
			font-family: serif;
			text-align: left;
			line-height: 1.1;
			background: white;
			z-index: 1;

		}




		.commentary {
			display: block;
			font-size: 15px;
			max-height: 64px;
 			background: white;
			text-overflow: ellipsis;
			overflow: hidden;
			cursor: pointer;
		}

		.commentary + .commentary {
			margin-top: 15px;
		}

		.highlight {
			background: #e6e6e6;
		}

		.lowlight {
			color: #bbb;

		}


		.commentator {
			margin-right: 4px;
		}

		.anchorText {
			font-weight: bold;
			font-style: italic;
			margin-right: 7px;
		}

		.open {
		   	position: absolute;
			width: 500px;
			font-size: 18px;
		  	padding: 20px 30px;
			background: white;
			z-index: 10;
			overflow: hidden;
			max-height: 350px;
			text-align: left;
			line-height: 1.2;
			-webkit-box-shadow: 2px 2px 12px #333333;
			-moz-box-shadow: 2px 2px 12px #333333;

		}

		.scrollCtl {
			background: white;
			z-index: 5;
			position: absolute;
			top: 86%;
			left: 31%;
		}

		.scrollCtl img {
			height: 22.5px;
			width: 27px;
			cursor: pointer;
		}

		.scrollCtl .up {
		}
		.scrollCtl .down {
			position: relative;
			top: -2px;
			left: 20px;
		}

		.openScrollCtl {
			position: absolute;
			left: 255px;
			bottom: 3px;
		}

		.openScrollCtl img {
			height: 18px;
			width: 21px;
			margin: 0px 5px;
			cursor: pointer;

		}

		#cScrollCtl {
			display: none;
			position: absolute;
			right: 19%;
			top: 84%;
		}

		#cScrollCtl img {
			height: 16px;
			width: 19px;
			cursor: pointer;
		}

		#cScrollCtl .down {
			position: relative;
			top: -2px;
			left: 14px;
		}

		.openBottom {
			overflow: hidden;
		}


		.preShadow {
			width: 1px;
			clear: both;
		}

		.shadow {
			clear: both;
		}

		.clear {
			clear: both;
		}

	</style>
</head>

<body>

<div data-role="page">
	<div data-role="header" data-position="fixed" id="top">
		<div id="topButtons">
			<span id="open" class="button">Open</span><span id="block" class="button">=</span><span id="inline" class="button">+</span>
		</div>
		<div id="header"></div>
		<div class="clear"></div>

		<div id="gotoBox">
			<div id="closeGoto">X</div>
			<h4>Open a book, chapter or verse:<h4>
				<input id="goto" />
				<div id="openEg">e.g., Proverbs, Psalms 4, Leviticus 6 2</div>
		</div>
	</div>

	<div data-role="content">
		<div id="basetext" class="caster"></div>
		<div data-position="fixed" id="commentaryBox"></div>
	</div>
</div>

<script type="text/javascript" src="/js/lib/jquery.js"></script>
<script type="text/javascript" src="/js/lib/jquery-ui-1.8.1.custom.min.js"></script>

<script type="text/javascript" src="/js/lib/jquery.scrollTo-1.4.2-min.js"></script>
<script type="text/javascript" src="/js/lib/jquery.easing.1.3.js"></script>

<script type="text/javascript" src="/js/lib/shadowcast.js"></script>
<script type="text/javascript" src="/js/lib/iscroll.js"></script>
<script type="text/javascript">

	// ------------ List of Book names that can serve as a ref -------------------
		books = ["Amos", "Chronicles 1", "Chronicles 2", "Daniel", "Deuteronomy", "Ecclesiastes", "Esther", "Exodus", "Ezekiel", "Ezra Nehemiah", "Genesis", "Habakkuk", "Haggai", "Hosea", "Isaiah", "Jeremiah", "Job", "Joel", "Jonah", "Joshua", "Judges", "Kings 1", "Kings 2", "Lamentations", "Leviticus", "Malachi", "Nahum", "Numbers", "Obadiah", "Proverbs", "Psalms", "Ruth", "Samuel 1", "Samuel 2", "Song of Songs", "Zechariah", "Zephaniah"]


	// --------------- Track First and Last Visible Verses

		firstVisible = new Object();
		lastVisible = new Object();

		book = "Genesis"
		chapter = "1"

		firstVisible.chapter = 1;
		firstVisible.verse = 1;
		lastVisible.chapter = 1;
		lastVisible.verse = 1;

		function loaded() {
			document.addEventListener('touchmove', function(e){ e.preventDefault(); });
			myScroll = new iScroll('basetext');
		}
		document.addEventListener('DOMContentLoaded', loaded);


	$(function() {


	// -------------- Window Resize Handlers --------------

		$(window).resize(function() {
			updateVisible();
		})

		$(window).scroll(function() {
			updateVisible();
		})

	// ------------- Top Button Handlers -------------

		$("#open").live("click", function() {
			$("#gotoBox").show()
			$("#goto").focus();
		})

		$("#closeGoto").live("click", function(){$("#gotoBox").hide()})

	// ------------- Next Link Url -----------------

		$("#next").live("click", function() {
			var ref = $(this).attr("data-ref");
			get(parseQuery(ref));
		})


	// ---------------- Layout Options ------------------

		$("#block").live("click", function(){
			$(".verse").addClass("block")
		})

		$("#inline").live("click", function(){
			$(".verse").removeClass("block")
		})

	// -------------- Load Texts--------------

		get(parseQuery("Genesis"));


	// ---------------- Large First Character ------------

	function makeLargeFirstChar() {
		var $fv = $(".verse:first")
		var text = $fv.text();
		var words = text.split(" ")
		$fv.empty()
		$fv.append("<span class='lfc'>" + words[0] + " " + words[1] + " " +words[2] +  "</span>")
		words.shift()
		words.shift()

		words.shift()

		var rest = " " + words.join(" ")
		console.log(rest)
		$fv.append("<span>" + rest + "</span>")
	}


	// ---------------------- Commentary Modal --------------------------

		$(".commentary").live("click", function(e){
			var $c = $(e.currentTarget);
			$c.clone().hide().appendTo("body")
				.removeClass("commentary").addClass("open")

			var $o	= $(".open");
			v = parseInt($o.attr("data-ref"))

			var h = $o.height();
			var w = $o.width();
			var mh = parseInt($o.css("max-height"));
			var p = parseInt($o.css("padding-top"));
			var pl = parseInt($o.css("padding-left"));
			var wh = $(window).height();
			var ww = $(window).width();

			if (h + (2*p) >= mh) {
				$o.wrapInner("<div class='openBottom' />");
				$o.children().eq(0).height(h - p)
				$o.append('<div class="openScrollCtl"> \
					<img src="/img/up.png" class="up"/> \
					<img src="/img/down.png" class="down"/> \
				</div>');
			} else {

			}

			$o.css("top", $(window).scrollTop() + (wh - (h+(2*p))) / 2.2 + "px");
			$o.css("left", (ww - (w+(2*pl))) / 2 + "px");

			$o.fadeIn("fast").draggable();
		});

	// ------------------- Commentary Model Hide ----------------------

		$(".open").live("click", function(e){
			$(".open").fadeOut("fast", function(){
				$(".open").remove();
			})
		})

	// -------------------- Update Commentary --------------------

		function updateCommentary() {

			for ( var i = firstVisible.verse; i <= lastVisible.verse; i++ ) {
				$(".commentary[data-ref=1:" + (i+1) + "]").each(function(i) {
					$(this).appendTo("#commentaryBox");
				});
			}

			$("#commentaryBox").fadeIn(1200);

			if (overflows($("#commentaryBox"))) {
				$("#cScrollCtl").fadeIn(100);
			}

			function hideCommentary() {
				$("#commentaryBox").fadeOut(100, function() {
					$("#commentaryBox .commentary").appendTo("#commentaryBuffer");
				});
				$("#cScrollCtl").fadeOut(100);

			}

		}

	//  -------------------- Update Visible Verse --------------------------

		function updateVisible() {
			var $v = $(".verse");
			var $w = $(window);
			var l = $v.length;

			for (var i = 0; i < l; i++) {
				var top = parseInt($v.eq(i).offset().top);
				var wtop = parseInt($w.scrollTop());
				if (top - wtop >= 80) {
					if (firstVisible.verse != i) {
						firstVisible.verse = i+1;
						var $comments = $("#commentaryBox .commentary[data-ref=" + i + "]")
						if ($comments.eq(0).length == 1) {
							$("#commentaryBox").clearQueue();
							$("#commentaryBox").scrollTo($comments.eq(0), 600)
						}
					}
					break;
				}
			}

			for (i = i; i < l; i++) {
				var bottom = $v.eq(i).offset().top + $v.eq(i).outerHeight();
				var wbottom = $w.height() + $w.scrollTop();
				if (bottom > wbottom) {
					if (lastVisible.verse != i) {
						lastVisible.verse = i + 1;
					}
					break;

				}
			}

			$("#header").html(book + " " + chapter + ":" + firstVisible.verse + "-" + lastVisible.verse)


		}

	// -------------------- Base Text Scrolling --------------------

		function btScroll(d) {
			$b = $("#basetext");
			var n = (d == 1 ? lastVisible.verse + 1 : firstVisible.verse - 3)
			n  = (n < 0 ? 0 : n);
			hideCommentary();
			$b.scrollTo($(".verse").eq(n), 700, {easing: "easeOutExpo", onAfter: function() {
				updateVisible();
				updateCommentary();
			}});
		}
		$(".scrollCtl .up").click(function(){
			btScroll(-1);
		});
		$(".scrollCtl .down").click(function(){
			btScroll(1);
		});


	// -------------------- Open Text Scrolling --------------------

		$(".openScrollCtl .up").live("click", function(e) {
			$b = $(".openBottom");
			var h = $b.height();
			var lh = parseInt($b.css("line-height"));
			h -= h % lh;
			$b.scrollTo("-=" + h + "px", 600, {easing: "easeOutExpo"});
			return false;
		});
		$(".openScrollCtl .down").live("click", function(e){
			$b = $(".openBottom");
			var h = $b.height();
			var lh = parseInt($b.css("line-height"));
			h -= h % lh;
			$b.scrollTo("+=" + h + "px", 600, {easing: "easeOutExpo"});
			return false;
		});

	// -------------- Commentary Scrolling --------------
		function cbScroll(d) {
			$cb = $("#commentaryBox")
			var h = $cb.height();
			var ds = (d == 1 ? "+=" : "-=");
			$cb.scrollTo(ds + h, 900, {easing: "easeOutExpo"})
		}

		$("#cScrollCtl .up").click(function(){
			cbScroll(-1);
		})

		$("#cScrollCtl .down").click(function() {
			cbScroll(1);
		})

	// -------------- Highlight Verse on Commentary Hover --------------


	$(".commentary").live("mouseenter", function (e) {

		if(typeof(offTimeout) != "undefined") clearTimeout(offTimeout)
		$c = $(e.currentTarget);
		var ref = $c.attr("data-ref");
		var verse = parseInt(ref) - 1;

		onTimeout = setTimeout("lowlightOn(" + verse + ")", 300)

	})
	$(".commentary").live("mouseleave", function (e) {
		if(typeof(onTimeout) != "undefined") clearTimeout(onTimeout)
		offTimeout = setTimeout("lowlightOff()", 300)
	})

	// -------------- Highlight Commentary on Verse Hover --------------

	$(".verse").live("mouseenter", verseHover);
	$(".verse").live("click", verseHover);

	function verseHover(e) {
		if(typeof(offTimeout) != "undefined") clearTimeout(offTimeout)

		var v = $(e.currentTarget).index() ;
		onTimeout = setTimeout("lowlightOn(" + v + ")", 300)

		var $comments = $("#commentaryBox .commentary[data-ref=" + v + "]")
		var $fc = $comments.eq(0);

		if ($fc.length == 1) {
			$("#commentaryBox").clearQueue();
			$("#commentaryBox").scrollTo($fc, 600, {easing: "easeOutExpo"});
		}
	}

	$(".verse").live("mouseleave", function () {
		if(typeof(onTimeout) != "undefined") clearTimeout(onTimeout)
		offTimeout = setTimeout("lowlightOff()", 300)
	})


	// ------------- Nav Queries -----------------

	function parseQuery(q) {
		response = {book: false, chapter: false, verse: false}
		p = q.split(" ")
		var offset = 0;
		if (p[0] in {Ezra: 1, Kings:1, Samuel: 1, Chronicles: 1}) {
			response.book = p[0][0].toUpperCase() + p[0].substr(1)  + " " + p[1][0].toUpperCase() + p[1].substr(1)
			offset = 1;
		} else if (p[0] in {Song: 1, song: 1}) {
			response.book = p[0][0].toUpperCase() + p[0].substr(1) + " " + p[1]  + " " + p[2][0].toUpperCase() + p[2].substr(1);
			offset = 2;
		} else {
			response.book = p[0][0].toUpperCase() + p[0].substr(1)
		}

		if (typeof(p[1+offset] != "undefined")) response.chapter = p[1+offset]
		if (typeof(p[2+offset] != "undefined")) response.verse = p[2+offset]

		return response;
	}


	$("#goto").keypress(function(e) {
			if (e.keyCode == 13) {
				q = parseQuery($("#goto").val());
				get(q);
			}
		})

	$("input#goto").autocomplete({ source: books });


	function get(q) {
			$("#header").html(q.book)
			if ($.inArray(q.book, books) < 0) {
				$("#header").html("Unknown book: <i>" + q.book + "</i>")
				return
			}
			$("body").scrollTo(0);
			$("#gotoBox").hide();
			$("#commentaryBox").empty()
			$("#basetext").html("<img id='loading' src='/img/ajax-loader.gif'/>")
			getStr = "/get.py?book=" + q.book
			if (q.chapter) getStr += "&chapter=" + q.chapter
			if (q.verse) getStr += "&verse=" + q.verse
			$("#goto").val("")
			$.getJSON(getStr, function(data) {
				$("#basetext").empty()
				if (data.error) {
					$("#header").html(data.error);
					return;
				}
				book = data.book;
				chapter = data.chapter;
				$("#header").html(data.title)
				for (var i = 0; i < data.text.length; i++) {
					$("#basetext").append("<span class='verse'>" + data.text[i] + "</span>")
				}

				if (data.next) {
					$("#basetext").append("<div id='next' data-ref='" +
											data.next + "'>Next: " +
											data.book + " " +
											(data.chapter +1) + "</div>")
				}

				makeLargeFirstChar()

				$(".verse").each(function(){
					var n = $(this).index() + 1;
					$(this).prepend("<div class='verseNum'>" + n + "</div>")
				})

				if (data.verse > 1) {
						$(window).scrollTo($(".verse").eq(data.verse - 1),
														600,
														{easing: "easeOutExpo", offset: {top: -160},
														onAfter: function() {
							$(".verse").eq(data.verse - 1).effect("highlight", 2000)
						}})

				}

				if (data.commentary) {
					$("commentaryBox").empty()
					for (var i = 0; i < data.commentary.length; i++) {
						c = data.commentary[i]
						$("#commentaryBox").append("<span class='commentary' data-ref='" + c.refVerse + "'><span class='commentator'>" + c.commentator + ":</span><span class='anchorText'>" + c.anchorText + "</span>" + c.text + "</span>")
					}
				}
				updateVisible();
			})
		}
});

// Check if a div is overflowing
// TODO: don't assume $div is absolute

	function overflows($div) {
		var h = $div.height();
		var $children = $div.children();
		for ( var i = 0; i < $children.length; i++) {
			if ($children.eq(i).position().top > h ) {
				return true;
			}
		}
		return false;
	}

// Determine is an element is scroll visible
// TODO: don't assume the parent is the scroll window

	function isScrollVis($div) {
		var t = $div.offset().top
		var h = $div.parent().outerHeight();
		var pt = $div.parent().offset().top;

		if (t < pt) return false;
		if (t > pt + h) return false;

		return true;
	}

	function lowlightOn(n) {

		$c = $("#commentaryBox .commentary[data-ref="+ (n+1) + "]")
		$(".commentary").addClass("lowlight")
		$c.removeClass("lowlight")
		$(".verse").addClass("lowlight")
		$(".verse").eq(n).removeClass("lowlight")
	}


	function lowlightOff() {
		$(".commentary").removeClass("lowlight")
		$(".verse").removeClass("lowlight")
	}

	</script>
	<script src="https://code.jquery.com/mobile/1.0a2/jquery.mobile-1.0a2.min.js"></script>

</body>
</html>
