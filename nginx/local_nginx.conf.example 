# Define CORS origin logic
map $http_origin $cors_origin {
    default "";
    ~^https:\/\/sheets\.([^\.]*\.cauldron\.)?(local)?sefaria.org(\.il)?$ "$http_origin";
}

# HTTP Redirect to HTTPS for localsefaria.org
server {
    listen 80;
    server_name localsefaria.org;
    return 301 https://$host$request_uri;
}

# HTTPS for localsefaria.org
server {
    listen 443 ssl;
    server_name localsefaria.org;

    ssl_certificate     /your/Sefaria-Project/path/nginx/ssl/localsefaria.crt;
    ssl_certificate_key /your/Sefaria-Project/path/nginx/ssl/localsefaria.key;

    location /sheets {
        if ($http_x_internal_proxy != "1") {
            set $sheets_host sheets.$host;
            return 301 https://$sheets_host$request_uri;
        }
        include /your/Sefaria-Project/path/nginx/cors.conf;
    }

    location / {
        include /your/Sefaria-Project/path/nginx/cors.conf;
    }
}

# HTTP Redirect to HTTPS for sheets.localsefaria.org
server {
    listen 80;
    server_name sheets.localsefaria.org;
    return 301 https://$host$request_uri;
}

# HTTPS for sheets.localsefaria.org
server {
    listen 443 ssl;
    server_name sheets.localsefaria.org;

    ssl_certificate     /your/Sefaria-Project/path/nginx/ssl/localsefaria.crt;
    ssl_certificate_key /your/Sefaria-Project/path/nginx/ssl/localsefaria.key;

    #redirection for service-worker that cannot be registered from redirection for security reasons
    location = /service-worker.js {
        alias /your/Sefaria-Project/path/static/js/service-worker.js;
        add_header Cache-Control "no-cache";
    }

    # This is needed for requests before the service worker is registered
    location /static/ {
        include /your/Sefaria-Project/path/nginx/common.conf;
    }
    location ~ ^/data\.\d+\.js$ {
        include /your/Sefaria-Project/path/nginx/common.conf;
    }
    location ~ /api/ {
        include /your/Sefaria-Project/path/nginx/common.conf;
    }

    # Document cases
    location ~ ^/sheets(/|$) { # Excludes /sheets-something
        include /your/Sefaria-Project/path/nginx/common.conf;
    }
    location / {
        rewrite ^/(.*)$ /sheets/$1 break;
        include /your/Sefaria-Project/path/nginx/common.conf;
    }
}
