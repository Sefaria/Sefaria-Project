name: Continuous
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  merge_group:
  push:
    branches:
      - master

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Prepare branch name for image tagging
  prepare-build:
    name: "Prepare Build Metadata"
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.branch-name.outputs.current_branch }}
      sha_short: ${{ steps.get-sha.outputs.sha_short }}
      image_tag: ${{ steps.image-tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Get branch name
        id: branch-raw
        uses: tj-actions/branch-names@v5.1
      - name: Format branch name
        id: branch-name
        run: >-
          echo "current_branch="$(echo ${{ steps.branch-raw.outputs.current_branch }}
          | awk '{print tolower($0)}'
          | sed 's|.*/\([^/]*\)/.*|\1|; t; s|.*|\0|'
          | sed 's/[^a-z0-9\.\-]//g')
          >> $GITHUB_OUTPUT
      - name: Set outputs
        id: get-sha
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - name: Determine image tag
        id: image-tag
        run: |
          echo "tag=sha-${{ steps.get-sha.outputs.sha_short }}" >> $GITHUB_OUTPUT

  # Build images using reusable workflow
  build-images:
    name: "Build Docker Images"
    needs: prepare-build
    uses: ./.github/workflows/build-images.yaml
    with:
      git_ref: ${{ github.sha }}
      image_tag: ${{ needs.prepare-build.outputs.image_tag }}
      branch_name: ${{ needs.prepare-build.outputs.branch_name }}
      environment: pr
      push_to_prod_registry: false
    secrets: inherit

#######
# Below Tests only run if PR is NOT draft
#######
  jest-tests:
    name: "Continuous Testing: Jest"
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          npm install
          npm run build-prod
      - run: ls
      - run: pwd
      - name: Run Jest Tests
        run: npm run jest-gha
      - name: Handle Jest Test Results
        run: cat /home/runner/jestResults.json; STATUS=`jq ".numFailedTestSuites" /home/runner/jestResults.json`; exit $STATUS
        if: ${{ always() }}

  check-python-files:
    runs-on: ubuntu-latest
    outputs:
      python_files_changed: ${{ steps.check-python-files.outputs.python_files_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Check for Python file changes
        id: check-python-files
        uses: dorny/paths-filter@v2
        with:
          filters: |
            python_files_changed:
              - added|modified:
                - '**/*.py'
                - 'requirements.txt'
                - 'setup.py'
                - 'pyproject.toml'

  sandbox-deploy:
    name: "Continuous Testing: Sandbox Deploy"
    concurrency:
      group: dev-mongo
      cancel-in-progress: false
    needs: [ build-images, check-python-files, prepare-build ]
    if: >
      github.event.pull_request.draft == false &&
      needs.check-python-files.outputs.python_files_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          token_format: 'access_token'
          workload_identity_provider: 'projects/${{ secrets.DEV_GKE_PROJECT_ID}}/locations/global/workloadIdentityPools/github/providers/github'
          service_account: '${{ secrets.DEV_GKE_SA }}'
      - name: Setup GCloud
        uses: google-github-actions/setup-gcloud@v0
        with:
          project_id: ${{ secrets.DEV_PROJECT }}
          install_components: 'gke-gcloud-auth-plugin'
      - name: Set up yq
        uses: frenck/action-setup-yq@v1
      - name: Authenticate GHA Runner To Target Cluster
        uses: google-github-actions/get-gke-credentials@v0
        with:
          cluster_name: ${{secrets.DEV_GKE_CLUSTER}}
          location: ${{secrets.DEV_GKE_REGION}}
          project_id: ${{secrets.DEV_GCP_PROJECT}}
      - name: Deploy Sandbox
        run: ./build/ci/sandbox-helm-deploy.sh build/ci/sandbox-values.yaml
        env:
          GIT_COMMIT: "${{ needs.prepare-build.outputs.sha_short }}"
          BRANCH: "${{ needs.prepare-build.outputs.branch_name }}"
          PROJECT_ID: "${{ secrets.DEV_PROJECT }}"
          NAMESPACE: "${{secrets.DEV_SANDBOX_NAMESPACE}}"

  sandbox-ready:
    if: >
      github.event.pull_request.draft == false &&
      needs.check-python-files.outputs.python_files_changed == 'true'
    needs: [sandbox-deploy, prepare-build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Wait for test sandbox to become available
        run: ./build/ci/waitForSandbox.bash
        env:
          WAIT_DURATION: "3000"
          GIT_COMMIT: "${{ needs.prepare-build.outputs.sha_short }}"

  pytest-job:
    name: "Continuous Testing: PyTest"
    concurrency:
      group: dev-mongo
      cancel-in-progress: false
    needs: [ sandbox-ready, check-python-files, prepare-build ]
    if: >
      github.event.pull_request.draft == false &&
      needs.check-python-files.outputs.python_files_changed == 'true'
    permissions:
      contents: 'read'
      id-token: 'write'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          token_format: 'access_token'
          workload_identity_provider: 'projects/${{ secrets.DEV_GKE_PROJECT_ID}}/locations/global/workloadIdentityPools/github/providers/github'
          service_account: '${{ secrets.DEV_GKE_SA }}'
      - name: Setup GCloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.DEV_PROJECT }}
          install_components: 'gke-gcloud-auth-plugin'
      - name: Authenticate GHA Runner To Target Cluster
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{secrets.DEV_GKE_CLUSTER}}
          location: ${{secrets.DEV_GKE_REGION}}
          project_id: ${{secrets.DEV_GCP_PROJECT}}
      - name: Start Job
        run: ./build/ci/createJobFromRollout.sh $GITHUB_RUN_ID $DEPLOY_ENV
        env:
          DEPLOY_ENV: sandbox-${{ needs.prepare-build.outputs.sha_short }}
      - name: Wait For Job To Finish
        run: ./build/ci/waitForCIJob.bash
        timeout-minutes: 60
        env:
          TEST_NAME: pytest
      - name: Get Logs From Cluster and propogate test result
        run: "kubectl logs --tail=-1 -l ci-run=$GITHUB_RUN_ID,test-name=pytest; LASTLINE=`kubectl logs --tail=1 -l ci-run=$GITHUB_RUN_ID,test-name=pytest`; STAT=${LASTLINE: -1}; exit $STAT"
      - name: Cleanup pyTest Pod
        run: kubectl delete jobs -l ci-run=$GITHUB_RUN_ID,test-name=pytest
        if: always()

  ending-notification:
    name: "Continuous Testing: Notifications"
    runs-on: ubuntu-latest
    if: ${{ always() && (github.event.pull_request.draft == false) }}
    needs:
      - pytest-job
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v2
        with:
          node-version: '14'
      - run: npm ci
        working-directory: ./build/notify
      - run: node notifyEnd.js
        working-directory: ./build/notify
        env:
          SLACK_TEST_SUCCESS_WEBHOOK_URL: ${{secrets.SLACK_TEST_SUCCESS_WEBHOOK_URL}}
          SLACK_TEST_FAILURE_WEBHOOK_URL: ${{secrets.SLACK_TEST_FAILURE_WEBHOOK_URL}}
          GITUSER_SLACK_MAP: ${{secrets.GITUSER_SLACK_MAP}}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sandbox-cleanup:
    name: "Continuous Testing: Clean up"
    if: ${{ always() && (github.event.pull_request.draft == false) }}
    needs:
      - pytest-job
      - prepare-build
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          token_format: 'access_token'
          workload_identity_provider: 'projects/${{ secrets.DEV_GKE_PROJECT_ID}}/locations/global/workloadIdentityPools/github/providers/github'
          service_account: '${{ secrets.DEV_GKE_SA }}'
      - name: Setup GCloud
        uses: google-github-actions/setup-gcloud@v0
        with:
          project_id: ${{ secrets.DEV_PROJECT }}
          install_components: 'gke-gcloud-auth-plugin'
      - name: Authenticate GHA Runner To Target Cluster
        uses: google-github-actions/get-gke-credentials@v0
        with:
          cluster_name: ${{secrets.DEV_GKE_CLUSTER}}
          location: ${{secrets.DEV_GKE_REGION}}
          project_id: ${{secrets.DEV_GCP_PROJECT}}
      - name: check helm
        id: get-helm
        run: echo "count=$(helm list -n $NAMESPACE | grep $NAME | wc -l)" >> $GITHUB_OUTPUT
        env:
          NAMESPACE: ${{ secrets.DEV_SANDBOX_NAMESPACE }}
          NAME: sandbox-${{ needs.prepare-build.outputs.sha_short }}
      - name: Uninstall
        run: helm delete sandbox-${{ needs.prepare-build.outputs.sha_short }} -n ${{ secrets.DEV_SANDBOX_NAMESPACE }} --debug --timeout 10m0s
        if: steps.get-helm.outputs.count > 0

  continuous-branch-protection:
    needs:
      - build-images
      - check-python-files
      - sandbox-deploy
      - sandbox-ready
      - pytest-job
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check required jobs
        run: |
          if [ "${{ github.event_name }}" == "merge_group" ]; then
            exit 0
          fi
          if [ "${{ needs.build-images.result }}" != "success" ]; then
            echo "Build images job failed"
            exit 1
          fi
          if [ "${{ github.event.pull_request.draft }}" == "false" ]; then
            if [ "${{ needs.check-python-files.outputs.python_files_changed }}" == "true" ]; then
              if [ "${{ needs.sandbox-deploy.result }}" != "success" ] || \
                 [ "${{ needs.sandbox-ready.result }}" != "success" ] || \
                 [ "${{ needs.pytest-job.result }}" != "success" ]; then
                echo "One or more Python-related test jobs failed"
                exit 1
              fi
            fi
          fi
