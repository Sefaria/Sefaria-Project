name: Notify Testing Status Change

on:
  workflow_dispatch:
    inputs:
      testing_enabled:
        description: 'Is TESTING now enabled? (true = merges allowed, false = merges blocked)'
        required: true
        type: boolean

jobs:
  notify-slack:
    name: "Notify Slack of Testing Status Change"
    runs-on: ubuntu-latest
    steps:
      - name: Get open PRs to modularization-main
        id: get-prs
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'modularization-main'
            });
            
            if (pullRequests.length === 0) {
              return 'No open PRs';
            }
            
            const prList = pullRequests.map(pr => {
              return `‚Ä¢ <${pr.html_url}|#${pr.number}: ${pr.title}> by ${pr.user.login}`;
            }).join('\n');
            
            core.setOutput('pr_list', prList);
            core.setOutput('pr_count', pullRequests.length);
            return prList;

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "Testing status changed for modularization-main",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ inputs.testing_enabled == true && '‚úÖ Merging Now Allowed' || 'üö´ Merging Now Blocked' }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*TESTING variable changed to:* `${{ inputs.testing_enabled }}`\n\n${{ inputs.testing_enabled == true && 'PRs can now be merged to `modularization-main`' || 'All merges to `modularization-main` are blocked during testing' }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Open PRs (${{ steps.get-prs.outputs.pr_count || 0 }}):*\n${{ steps.get-prs.outputs.pr_list || 'No open PRs' }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ inputs.testing_enabled == true && '‚ö†Ô∏è *Action Required:* PR authors should re-run the \"Check Testing Status\" workflow in their PRs to unblock merging.' || 'üìã Testing in progress. PRs will be blocked until TESTING is set back to true.' }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Changed by: ${{ github.actor }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.MODULARIZATION_SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

