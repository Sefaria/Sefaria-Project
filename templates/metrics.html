{% extends "base.html" %}
{% load i18n cache humanize sefaria_tags %}
{% load i18n %}
{% load static %}
{% block title %}{% trans "Sefaria Metrics" %}{% endblock %}

{% block description %}{% trans "See graphs charting Sefaria's progress since 2013 across metrics including word counts, number of links and number of source sheets." %}{% endblock %}

{% block content %}
<div class="superAbout">
    {% if not request.user_agent.is_mobile %}
        {% include '_sidebar.html' with whichPage='metrics' %}
    {% endif %}
    <div id="metricsPage" class="biReady container static">


        <div class="inner">
                <h1 class="aboutHeader">
                    <span class="int-en">Metrics</span>
                    <span class="int-he">מדדים</span>
                </h1>
            <div id="metricsBox">
                {% trans "Loading..." %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %} 
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
	var metrics = {% autoescape off %}{{ metrics_json }}{% endautoescape %};
	
	for (var i = 0; i < metrics.length; i++) {
		metrics[i]["totalWords"] = metrics[i]["heWords"] + metrics[i]["transWords"];
	}

	var titles = {
			"totalWords": "{% trans "Total Words in Library" %}",
			"heWords": "{% trans "Words in Hebrew & Aramaic" %}",
			"transWords": "{% trans "Words in Translation" %}",
			"sctWords": "{% trans "Words of Original Translation created by Sefaria Volunteers" %}",
			"contributors": "{% trans "Number of Public Contributors" %}",
			"links": "{% trans "Number of Intertextual Links" %}",
			"sheets": "{% trans "Number of Source Sheets" %}"
	};

	var paletteColors = {
		darkteal:  "#004e5f",
		raspberry: "#7c406f",
		green:     "#5d956f",
		paleblue:  "#9ab8cb",
		blue:      "#4871bf",
		orange:    "#cb6158",
		lavender:  "#7f85a9",
		yellow:    "#ccb479",
		purple:    "#594176",
		teal:      "#00827f"
	};

	var metricColors = {
		totalWords: paletteColors.blue,
		heWords: paletteColors.darkteal,
		transWords: paletteColors.teal,
		sctWords: paletteColors.orange,
		contributors: paletteColors.purple,
		links: paletteColors.raspberry,
		sheets: paletteColors.green
	};

	var metricUnits = {
			"totalWords": "{% trans "Words" %}",
			"heWords": "{% trans "Words" %}",
			"transWords": "{% trans "Words" %}",
			"sctWords": "{% trans "Words" %}",
			"contributors": "{% trans "Contributors" %}",
			"links": "{% trans "Links" %}",
			"sheets": "{% trans "Source Sheets" %}"
	};

	var hexToRgba = function(hex, alpha) {
		if (!hex) {
			return "rgba(0, 0, 0, " + alpha + ")";
		}
		var sanitized = hex.replace("#", "");
		if (sanitized.length === 3) {
			sanitized = sanitized.split("").map(function(char) {
				return char + char;
			}).join("");
		}
		var bigint = parseInt(sanitized, 16);
		var r = (bigint >> 16) & 255;
		var g = (bigint >> 8) & 255;
		var b = bigint & 255;
		return "rgba(" + r + ", " + g + ", " + b + ", " + alpha + ")";
	};

	var formatNumber = function(value) {
		if (value === null || value === undefined) {
			return "—";
		}
		var numericValue = Number(value);
		if (isNaN(numericValue)) {
			return value;
		}
		return numericValue.toLocaleString();
	};

	if (window.Chart && window.Chart.defaults) {
		Chart.defaults.color = "#2A3B52";
		Chart.defaults.font.family = '"Roboto","Helvetica Neue","Helvetica",sans-serif';
		Chart.defaults.font.size = 14;
		Chart.defaults.elements.line.borderWidth = 3;
		Chart.defaults.elements.point.radius = 0;
		Chart.defaults.elements.point.hitRadius = 15;
		Chart.defaults.transitions.active.animation.duration = 200;
		Chart.defaults.plugins.tooltip.cornerRadius = 6;
		Chart.defaults.plugins.tooltip.displayColors = false;
	}

	var labels = [];
	for (var i = 0; i < metrics.length; i++) {
		var timestamp = metrics[i]["timestamp"]["$date"];
		var a = new Date(timestamp);
 		var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
		var month = months[a.getMonth()];
		var date = a.getDate();

		labels.push(month + " " + date + ", " + a.getFullYear());
	}

	var chartInstances = {};

	var destroyCharts = function() {
		for (var key in chartInstances) {
			if (chartInstances.hasOwnProperty(key) && chartInstances[key]) {
				chartInstances[key].destroy();
			}
		}
		chartInstances = {};
	};

	var makeData = function(field) {
		var data = [];
		for (var i = 0; i < metrics.length; i++) {
			data.push(metrics[i][field]);
		}
		return data;
	};

	var makeChart = function(field) {
		var dataset = makeData(field);
		var canvasId = field + "Canvas";
		var color = metricColors[field] || paletteColors.blue;
		var $container = $("<div>", { id: field, "class": "chart" });
		var $header = $("<div>", { "class": "chartHeader" });
		$header.append($("<span>", { "class": "chartTitle", text: titles[field] }));
		var latestValue = dataset.length ? dataset[dataset.length - 1] : null;
		var $valueGroup = $("<div>", { "class": "chartValueGroup" });
		$valueGroup.append($("<span>", { "class": "chartValue", text: formatNumber(latestValue) }));
		if (metricUnits[field]) {
			$valueGroup.append($("<span>", { "class": "chartSubtitle", text: metricUnits[field] }));
		}
		$header.append($valueGroup);
		$container.append($header);
		var $canvasWrapper = $("<div>", { "class": "chartCanvasWrapper" });
		var $canvas = $("<canvas>", { id: canvasId });
		$canvasWrapper.append($canvas);
		$container.append($canvasWrapper);
		$("#metricsBox").append($container);

		var ctx = document.getElementById(canvasId).getContext("2d");

		if (chartInstances[field]) {
			chartInstances[field].destroy();
		}

		chartInstances[field] = new Chart(ctx, {
			type: "line",
			data: {
				labels: labels,
				datasets: [{
					label: titles[field],
					data: dataset,
					borderColor: color,
					backgroundColor: hexToRgba(color, 0.18),
					pointBackgroundColor: color,
					pointHoverBackgroundColor: color,
					pointHoverRadius: 5,
					pointHoverBorderWidth: 0,
					tension: 0.35,
					fill: true
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				interaction: {
					mode: "index",
					intersect: false
				},
				plugins: {
					legend: {
						display: false
					},
					tooltip: {
						backgroundColor: "#073570",
						borderColor: hexToRgba(color, 0.4),
						borderWidth: 1,
						titleColor: "#ffffff",
						bodyColor: "#ffffff",
						callbacks: {
							label: function(context) {
								var value = context.parsed.y;
								if (value && typeof value.toLocaleString === "function") {
									value = value.toLocaleString();
								}
								return context.dataset.label + ": " + value;
							}
						}
					}
				},
				scales: {
					x: {
						display: false,
						grid: {
							display: false
						}
					},
					y: {
						grid: {
							color: "rgba(7, 53, 112, 0.08)",
							drawBorder: false
						},
						ticks: {
							padding: 10,
							callback: function(value) {
								if (typeof value.toLocaleString === "function") {
									return value.toLocaleString();
								}
								return value;
							}
						}
					}
				}
			}
		});
	};

	var makeCharts = function() {
		destroyCharts();
		$("#metricsBox").empty();
		for (var field in titles) {
    		if (titles.hasOwnProperty(field)) {
       			makeChart(field);
    		}
		}
	};

	$(function() {
		makeCharts();
	});
</script>
{% endblock %}
